Example technique for retrieving hashes with a given tag from ThreatExchange, as well as uploading.

# Purpose of this code

You can use this for downloading/uploading hashes from/to ThreatExchange, found by tag. You can use the Java code as-is, or use it to illuminate tooling in other languages. Note that `java TETagQuery -s ...` will print the URLs this tool constructs for you, to help make clear how to access ThreatExchange via URLs.

# Query mechanism

* We use the `tagged_objects` endpoint to fetch IDs of all hashes. This
endpoint doesn't return all desired metadata fields, so we use it as a quick
map from tag ID to list of hash IDs. This is relatively quick.

* Then for each resulting hash ID we do a query for all fields associated with
that ID. This is relatively slow, but batching multiple IDs per query helps a
lot.

# Contact

threatexchange@fb.com

# Compiling the code

```
javac com/facebook/threatexchange/*.java
```

# Setup

* Find your app's access token at https://developers.facebook.com/tools/accesstoken/

* Put this into `~/.txtoken` and `chmod 600 ~/.txtoken`

* `export TX_ACCESS_TOKEN=$(cat ~/.txtoken)` in your shell's init file

# Examples of using the code for queries

On-line help:
```
java com.facebook.threatexchange.TETagQuery --help
```

Querying for all hashes of a given type:
```
java com.facebook.threatexchange.TETagQuery tag-to-details --indicator-type pdq media_type_photo

java com.facebook.threatexchange.TETagQuery -v tag-to-details --indicator-type pdq media_type_photo

java com.facebook.threatexchange.TETagQuery tag-to-details --indicator-type md5 media_type_video

java com.facebook.threatexchange.TETagQuery tag-to-details \
  --page-size 10 \
  --data-dir ./tmk-data-dir \
  --indicator-type tmk \
  media_type_long_hash_video
```

Querying for some hashes of a given type:
```
java com.facebook.threatexchange.TETagQuery tag-to-details --indicator-type pdq --tagged-since -1day media_type_photo

java com.facebook.threatexchange.TETagQuery tag-to-details --indicator-type md5 --tagged-since -1week media_type_video

java com.facebook.threatexchange.TETagQuery tag-to-details \
  --page-size 10 \
  --data-dir ./tmk-data-dir \
  --indicator-type tmk \
  --tagged-since -1week \
  media_type_long_hash_video
```

# Examples of using the code for posts

Post a new SHA1 hash:

```
java com.facebook.threatexchange.TETagQuery submit \
  -i dabbad00f00dfeed5ca1ab1ebeefca11ab1ec00e \
  -t HASH_SHA1 \
  -d "testing te-tag-query with post" \
  -l AMBER \
  -s NON_MALICIOUS \
  -p HAS_WHITELIST \
  --privacy-members 1064060413755420 \
  --tags testing_java_post
```

Post another with relation to the first one:

```
java com.facebook.threatexchange.TETagQuery submit \
  -i dabbad00f00dfeed5ca1ab1ebeefca11ab1ec00f \
  -t HASH_SHA1 \
  -d "testing te-tag-query with post" \
  -l AMBER \
  -s NON_MALICIOUS \
  -p HAS_WHITELIST \
  --privacy-members 1064060413755420 \
  --tags testing_java_post \
  --related-triples-for-upload-as-json '[{"owner_app_id":494491891138576,"td_indicator_type":"HASH_SHA1","td_raw_indicator":"dabbad00f00dfeed5ca1ab1ebeefca11ab1ec00e"}]'
```

Post a new TMK hash:

```
java com.facebook.threatexchange.TETagQuery \
  submit \
    -i ../tmk/sample-hashes/chair-22-sd-sepia-bar.tmk \
    -t HASH_TMK \
    -d "testing te-tag-query with post" \
    -l AMBER \
    -s NON_MALICIOUS \
    -p HAS_WHITELIST \
    --privacy-members 1064060413755420 \
    --tags testing_java_post
```

# URL-generation notes

As noted at the top of this document, the `TETagQuery` program is intended to be a reference design -- for you to use as-is, or to help you write tooling in other languages.

As noted above, the `TETagQuery` program uses a three-step process: tag text to tag ID; tag ID to tagged objects (with pagination); each page of tagged-object IDs to their details.

Here, for reference, we show what those bare-curl commands look like if you're not using the Java code.

The HTTP queries shown below were generated by running `TETagQuery -s ...`; those URLs were dropped into a browser to obtain the raw JSON responses shown below.

## Step 1: tag text to tag ID

HTTP query:

```
https://graph.facebook.com/v4.0/threat_tags/
  ?access_token=REDACTED&text=pwny
```

JSON response:

```
{
   "data": [
      {
         "id": "2722789434440042",
         "text": "pwny2"
      },
      {
         "id": "1283621968426798",
         "text": "pwny"
      }
   ],
   "paging": {
      "cursors": {
         "before": "MAZDZD",
         "after": "MQZDZD"
      }
   }
}
```

This does a prefix-match so select and retain the ID for the exact match `pwny`.

## Step 2: tag ID to tagged-object IDs

HTTP query:

```
https://graph.facebook.com/v4.0/1283621968426798/tagged_objects/
  ?access_token=REDACTED
  &limit=1000
```

JSON response:

```
{
   "data": [
      {
         "id": "2556006484495859",
         "type": "THREAT_DESCRIPTOR",
         "name": "ginuwine1551474919abc-2.evilevillabs.com"
      },
      {
         "id": "2356527701137016",
         "type": "THREAT_DESCRIPTOR",
         "name": "e8b19da37825a3056e84c522f05ee081"
      },
      ...
  ],
  "paging": {
    "cursors": {
      "before": "REDACTED",
      "after": "REDACTED"
    },
   "next": "https://graph.facebook.com/v6.0/2733125556794397/tagged_objects?access_token=REDACTED&limit=1000&after=..."
  }
}
```

If there is no next page the `response.paging.next` will be absent. If it is present, you can simply curl it as-is to follow the next page, and the next, until there are no more.

## Step 3: tagged-object IDs to descriptor details

Here we collect the IDs from the above single-page JSON response and get details for each of them.

HTTP query:

```
https://graph.facebook.com/v4.0/
  ?access_token=REDACTED
  &ids=%5B 2556006484495859,2356527701137016,...%5D
  &fields=raw_indicator,type,added_on,last_updated,confidence,owner,privacy_type,review_status,status,severity,share_level,tags,description
```

JSON response:

```
{
   "2556006484495859": {
      "raw_indicator": "ginuwine1551474919abc-2.evilevillabs.com",
      "type": "DOMAIN",
      "added_on": "2019-11-09T02:58:41+0000",
      "last_updated": "2019-11-09T02:58:42+0000",
      "confidence": 80,
      "owner": {
         "id": "494491891138576",
         "email": "redacted@redacted.com",
         "name": "Media Hash Sharing RF Test"
      },
      "privacy_type": "HAS_PRIVACY_GROUP",
      "review_status": "REVIEWED_MANUALLY",
      "status": "UNKNOWN",
      "severity": "INFO",
      "share_level": "AMBER",
      "tags": {
         "data": [
            {
               "id": "1283621968426798",
               "text": "pwny"
            },
            {
               "id": "1928945133884049",
               "text": "ignore"
            },
            {
               "id": "884078131700721",
               "text": "testing"
            }
         ]
      },
      "description": "Testing camel-casing codemod",
      "id": "2556006484495859"
   },
  ...
}
```

Here there is no next page since the details are from a list of IDs specified in the HTTP query.
